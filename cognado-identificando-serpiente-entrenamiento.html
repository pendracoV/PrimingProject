<!DOCTYPE html>
<html>
    <body>
        <div hidden>
            <!-- Precargue de imagenes para aumentar performance -->
            <img id="paisaje" src="assets/cueva.webp" />
        </div>

        <div style="text-align: center;">
            <canvas id="canvas" style="border:1px solid #d3d3d3;">
                Tu navegador no soporta este video Juego. Deber actualizar el navegador o usar otro.
            </canvas>
        </div>

        <script>
            // Globales
            const debugIsActive = false;
            var studentName = "";
            var age = "";
            var studentLevel = "";
            var schoolName = "";
            var schedule = "";

            var ubicacionActualSerpienteX = 0;
            var ubicacionActualSerpienteY = 0;

            var clicksSobreSerpiente = 0;

            // Analiticas del juego
            var cantidadErrores = 0;
            var cantidadAciertos = 0;
            var cantidadIntentos = 0;
            var fechaInicio = '';
            var fechaFin = '';

            var cognadoSeleccionado = null;

            var cognados = [
                {
                    id: 1,
                    nombre: "MANGO",
                    sonidoCorrecto: "assets/cognados/1-EN_MANGOU.mp3",
                    sonidoIncorrecto: "assets/cognados/1-ES_Mango.mp3"
                },
                {
                    id: 2,
                    nombre: "MELON",
                    sonidoCorrecto: "assets/cognados/2-EN_MELLON.mp3",
                    sonidoIncorrecto: "assets/cognados/2-ES_Melon.mp3"
                },
                {
                    id: 3,
                    nombre: "GORILA",
                    sonidoCorrecto: "assets/cognados/3-EN_GORILLA.mp3",
                    sonidoIncorrecto: "assets/cognados/3-ES_Gorila.mp3"
                },
                {
                    id: 4,
                    nombre: "COCO",
                    sonidoCorrecto: "assets/cognados/4-EN_COCONUT.mp3",
                    sonidoIncorrecto: "assets/cognados/4-ES_Coco.mp3"
                },
                {
                    id: 5,
                    nombre: "MANDARINA",
                    sonidoCorrecto: "assets/cognados/5-EN_MANDARIN.mp3",
                    sonidoIncorrecto: "assets/cognados/5-ES_Mandarina.mp3"
                },
                {
                    id: 6,
                    nombre: "BANANO",
                    sonidoCorrecto: "assets/cognados/6-EN_BANANA.mp3",
                    sonidoIncorrecto: "assets/cognados/6-ES_Banano.mp3"
                },
                {
                    id: 7,
                    nombre: "LIMON",
                    sonidoCorrecto: "assets/cognados/7-EN_LEMON.mp3",
                    sonidoIncorrecto: "assets/cognados/7-ES_Limon.mp3"
                },
                {
                    id: 8,
                    nombre: "ELEFANTE",
                    sonidoCorrecto: "assets/cognados/8-EN_ELEPHANT.mp3",
                    sonidoIncorrecto: "assets/cognados/8-ES_Elefante.mp3"
                },
                {
                    id: 9,
                    nombre: "HIPOPOTAMO",
                    sonidoCorrecto: "assets/cognados/9-EN_HIPPOPOTAMUS.mp3",
                    sonidoIncorrecto: "assets/cognados/9-ES_Hipopotamo.mp3"
                },
                {
                    id: 10,
                    nombre: "DELFIN",
                    sonidoCorrecto: "assets/cognados/10-EN_DOLPHIN.mp3",
                    sonidoIncorrecto: "assets/cognados/10-ES_Delfin.mp3"
                },
                {
                    id: 11,
                    nombre: "COCODRILO",
                    sonidoCorrecto: "assets/cognados/11-EN_CROCODILE.mp3",
                    sonidoIncorrecto: "assets/cognados/11-ENCocodrilo.mp3"
                },
                {
                    id: 12,
                    nombre: "JIRAFA",
                    sonidoCorrecto: "assets/cognados/12-EN_GIRAFFIE.mp3",
                    sonidoIncorrecto: "assets/cognados/12-ES_Jirafa.mp3"
                },
                {
                    id: 13,
                    nombre: "DINOSAURIO",
                    sonidoCorrecto: "assets/cognados/13-EN_DINOSAUR.mp3",
                    sonidoIncorrecto: "assets/cognados/13-ES_Dinosaurio.mp3"
                },
                {
                    id: 14,
                    nombre: "LEON",
                    sonidoCorrecto: "assets/cognados/14-EN_LION.mp3",
                    sonidoIncorrecto: "assets/cognados/14-ES_Leon.mp3"
                },
                {
                    id: 15,
                    nombre: "PAPAYA",
                    sonidoCorrecto: "assets/cognados/15-EN_PAPAYA.mp3",
                    sonidoIncorrecto: "assets/cognados/15-ES_Papaya.mp3"
                }
            ];

            // Configuracion del canvas
            const draw = (canvas) => {
                const ctx = canvas.getContext("2d");
            }

            var canvas = document.getElementById("canvas");
            var ctx = canvas.getContext("2d");
            canvas.height = window.innerHeight
            canvas.width = window.innerWidth

            // Dibujos
            function dibujarPaisaje(){
                if (debugIsActive) { console.log('method: dibujarPaisaje()') }
                var isla = document.getElementById("paisaje");
                ctx.drawImage(isla, 0, 0, canvas.width, canvas.height);
            }

            function dibujarSerpiente(imagenSerpiente='') {
                if (debugIsActive) { console.log('method: dibujarSerpiente()') }
                serpiente = new Image();
                serpiente.onload = function() {
                    ubicacionActualSerpienteX = canvas.getBoundingClientRect().width - (canvas.getBoundingClientRect().width/4)
                    ubicacionActualSerpienteY = canvas.getBoundingClientRect().height / 1.5
                    ctx.drawImage(serpiente, ubicacionActualSerpienteX, ubicacionActualSerpienteY);
                };
                serpiente.src = imagenSerpiente;
            }

            function playSound(sound='') {
                new Audio(sound).play();
            }

            function elegirCognadoParaEntrenar() {
                random = Math.floor(Math.random() * cognados.length)
                cognadoSeleccionado = cognados[random]
            }

            function onCanvasClick(e){
                if (clickOnSerpiente(e.clientX, e.clientY)) {
                    // playSound("assets/sonido_serpiente_venenosa.mp3")
                    playSound(cognadoSeleccionado.sonidoCorrecto)
                    clicksSobreSerpiente += 1;
                    if (clicksSobreSerpiente >= 10) {
                        setTimeout(function(){
                            window.location.replace("cognado-identificando-serpiente-tarea.html"+buildPathParams());
                        }, 2000);
                    }
                }
            }

            function clickOnSerpiente(x, y) {
                const respuesta = ubicacionActualSerpienteX < x + 80 && ubicacionActualSerpienteX > x - 80
                && ubicacionActualSerpienteY < y + 80 && ubicacionActualSerpienteY > y - 80
                var mensaje = "Serpiente=>("+ubicacionActualSerpienteX+","+ubicacionActualSerpienteY+"), Click=>("+x+","+y+"), R=>["+respuesta+"]";
                if (debugIsActive) { console.log('method: clickOnSerpiente() => ' + mensaje) }
                return respuesta;
            }

            function dibujarCoins(){
                if (debugIsActive) { console.log('method: dibujarCoins()') }
                onWonCoins()
                coin = new Image();
                coin.onload = function() {
                    ctx.drawImage(coin, canvas.getBoundingClientRect().width - 100, 50);
                };
                imagen_moneda = '';
                if (ganoMonedas) {
                    imagen_moneda = 'assets/coins+10.png';
                } else {
                    imagen_moneda = 'assets/coins-10.png';
                }
                coin.src = imagen_moneda;
            }

            function randomIntFromInterval(min, max) { // min and max included 
                return Math.floor(Math.random() * (max - min + 1) + min)
            }

            function moverSerpiente() {
                clearCanvasSinSerpiente();
                const movimiento = randomIntFromInterval(1, 3)
                switch (movimiento) {
                    case 1:
                        dibujarSerpiente('assets/serpiente_mirando_derecha.png')
                      break;
                    case 2:
                        dibujarSerpiente('assets/serpiente_mirando_izquierda.png')
                      break;
                    case 3:
                        dibujarSerpiente('assets/serpiente_mirando_frente.png')
                      break;
                    default:
                        dibujarSerpiente('assets/serpiente_mirando_derecha.png')
                  }
            }

            function clearCanvasSinSerpiente(){
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                dibujarPaisaje();
            }

            function buildPathParams(){
                return "?studentName="+studentName+"&age="+age+"&level="+studentLevel+"&school="+schoolName+"&schedule="+schedule+"&cognadoId="+cognadoSeleccionado.id;
            }

            function getURLParameter(sParam){
                var sPageURL = window.location.search.substring(1);
                var sURLVariables = sPageURL.split('&');
                for (var i = 0; i < sURLVariables.length; i++) {
                    var sParameterName = sURLVariables[i].split('=');
                    if (sParameterName[0] == sParam) {
                        return sParameterName[1];
                    }
                }
            }

            function readAndLoadUserDataFromUrl() {
                studentName = getURLParameter('studentName');
                age = getURLParameter('age');
                level = getURLParameter('level');
                school = getURLParameter('school');
                schedule = getURLParameter('schedule');
            }

            function getCompleteDate(){
                const currentdate = new Date();
                return currentdate.getDate() + "/"
                + (currentdate.getMonth()+1)  + "/" 
                + currentdate.getFullYear() + "|"  
                + currentdate.getHours() + ":"  
                + currentdate.getMinutes() + ":" 
                + currentdate.getSeconds();
            }

            // Eventos de window
            window.onload = function() {
                fechaInicio = getCompleteDate()
                readAndLoadUserDataFromUrl()
                dibujarPaisaje();
                dibujarSerpiente(imagenSerpiente='assets/serpiente_mirando_derecha.png');
                elegirCognadoParaEntrenar();
                var intervaloMiradaSerpiente = setInterval(moverSerpiente,1500);
            }

            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth
                canvas.height = window.innerHeight
                draw(canvas)
                dibujarPaisaje();
            })

            canvas.addEventListener("click", onCanvasClick);

        </script>

    </body>
</html>